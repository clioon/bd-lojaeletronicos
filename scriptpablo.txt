DROP TABLE IF EXISTS Fidelidade_Cliente CASCADE;
DROP TABLE IF EXISTS Item_Pedido CASCADE;
DROP TABLE IF EXISTS Desconto_Aplicado CASCADE;
DROP TABLE IF EXISTS Pagamento CASCADE;
DROP TABLE IF EXISTS Venda CASCADE;
DROP TABLE IF EXISTS Pedido CASCADE;
DROP TABLE IF EXISTS Periferico CASCADE;
DROP TABLE IF EXISTS Hardware CASCADE;
DROP TABLE IF EXISTS Dispositivo CASCADE;
DROP TABLE IF EXISTS Produto CASCADE;
DROP TABLE IF EXISTS Cliente CASCADE;

-- Tipos ENUM 
DO $$ BEGIN
    CREATE TYPE status_pedido_t AS ENUM ('iniciado', 'pendente', 'enviando', 'concluido', 'cancelado');
EXCEPTION WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
    CREATE TYPE prioridade_pedido_t AS ENUM ('baixa', 'media', 'alta');
EXCEPTION WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
    CREATE TYPE modo_envio_t AS ENUM ('entrega', 'retirada');
EXCEPTION WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
    CREATE TYPE forma_pagamento_t AS ENUM ('cartao_credito', 'cartao_debito', 'boleto', 'pix', 'transferencia', 'dinheiro');
EXCEPTION WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
    CREATE TYPE tipo_desconto_t AS ENUM ('promocional', 'cupom', 'fidelidade', 'parceria', 'outros');
EXCEPTION WHEN duplicate_object THEN null;
END $$;



-- Criação das tabelas

CREATE TABLE Cliente (
	id_cliente SERIAL PRIMARY KEY,
	nome_cliente VARCHAR(255) NOT NULL,
	cidade VARCHAR(100) NOT NULL,
	estado VARCHAR(100) NOT NULL,
	pais VARCHAR(100) NOT NULL,
	data_cadastro DATE DEFAULT CURRENT_DATE NOT NULL
);

CREATE TABLE Produto (
    id_produto SERIAL PRIMARY KEY,
    nome_produto VARCHAR(255) NOT NULL,
    categoria VARCHAR(100) NOT NULL,
    preco_unitario NUMERIC(10,2) NOT NULL,
    custo_unitario NUMERIC(10,2) NOT NULL,
    estoque_atual INT NOT NULL,
    estoque_minimo INT NOT NULL
);

CREATE TABLE Dispositivo (
    id_produto INT PRIMARY KEY,
    cor VARCHAR(50) NOT NULL,
    dimensao VARCHAR(50) NOT NULL,
    tipo VARCHAR(100) NOT NULL,
    FOREIGN KEY (id_produto) REFERENCES Produto(id_produto) ON DELETE CASCADE
);

CREATE TABLE Hardware (
    id_produto INT PRIMARY KEY,
    consumo_energia INT NOT NULL,
    especificacao_tecnica VARCHAR(255),
    tipo VARCHAR(100) NOT NULL,
    FOREIGN KEY (id_produto) REFERENCES Produto(id_produto) ON DELETE CASCADE
);

CREATE TABLE Periferico (
    id_produto INT PRIMARY KEY,
    cor VARCHAR(50) NOT NULL,
    conexao VARCHAR(50) NOT NULL,
    tipo VARCHAR(100) NOT NULL,
    FOREIGN KEY (id_produto) REFERENCES Produto(id_produto) ON DELETE CASCADE
);

CREATE TABLE Pedido (
    id_pedido SERIAL PRIMARY KEY,
    data_pedido DATE NOT NULL,
    prazo_estimado DATE NOT NULL,
    status_pedido status_pedido_t DEFAULT 'iniciado' NOT NULL,
    prioridade_pedido prioridade_pedido_t DEFAULT 'media' NOT NULL,
    modo_envio modo_envio_t DEFAULT 'entrega' NOT NULL,
    id_cliente INT NOT NULL,
    pontos_fidelidade_gerados INT NOT NULL DEFAULT 0,
    FOREIGN KEY (id_cliente) REFERENCES Cliente(id_cliente) ON DELETE CASCADE
);



CREATE TABLE Venda (
    id_pedido INT PRIMARY KEY,
    custo_envio NUMERIC(10,2) NOT NULL,
    custo_imposto_loja NUMERIC(10,2) NOT NULL,
    custo_taxa_pagamento NUMERIC(10,2) NOT NULL,
    valor_frete NUMERIC(10,2) NOT NULL,
    valor_imposto_cliente NUMERIC(10,2) NOT NULL,
    subtotal NUMERIC(10,2) NOT NULL,
    valor_desconto NUMERIC(10,2) NOT NULL,
    valor_total NUMERIC(10,2) NOT NULL,
    FOREIGN KEY (id_pedido) REFERENCES Pedido(id_pedido) ON DELETE CASCADE
);

CREATE TABLE Pagamento (
    id_pedido INT PRIMARY KEY,
    forma_pagamento forma_pagamento_t NOT NULL,
    parcelas INT NOT NULL DEFAULT 1,
    data_pagamento DATE NOT NULL,
    valor_pago NUMERIC(10,2) NOT NULL,
    FOREIGN KEY (id_pedido) REFERENCES Venda(id_pedido) ON DELETE CASCADE
);

CREATE TABLE Desconto_Aplicado (
    id_desconto SERIAL PRIMARY KEY,
    id_pedido INT DEFAULT NULL,
    tipo tipo_desconto_t NOT NULL,
    porcentagem NUMERIC(5,2) NOT NULL,
    descricao VARCHAR(200),
    FOREIGN KEY (id_pedido) REFERENCES Venda(id_pedido) ON DELETE CASCADE
);

CREATE TABLE Item_Pedido (
    id_pedido INT NOT NULL,
    id_produto INT NOT NULL,
    quantidade INT NOT NULL,
    preco_unitario NUMERIC(10,2) NOT NULL,
    desconto_unitario NUMERIC(10,2) NOT NULL DEFAULT 0,
    valor_total_item NUMERIC(10,2) NOT NULL,
    PRIMARY KEY (id_pedido, id_produto),
    FOREIGN KEY (id_pedido) REFERENCES Pedido(id_pedido) ON DELETE CASCADE,
    FOREIGN KEY (id_produto) REFERENCES Produto(id_produto) ON DELETE CASCADE
);

CREATE TABLE Fidelidade_Cliente (
    id_cliente INT PRIMARY KEY,
    pontos_acumulados INT NOT NULL,
    FOREIGN KEY (id_cliente) REFERENCES Cliente(id_cliente) ON DELETE CASCADE
);


-- Início da Transação
BEGIN;

-- 1. INSERINDO CLIENTES
INSERT INTO Cliente (id_cliente, nome_cliente, cidade, estado, pais, data_cadastro) VALUES
(1, 'João Silva', 'São Paulo', 'SP', 'Brasil', '2023-01-15'),
(2, 'Maria Oliveira', 'Rio de Janeiro', 'RJ', 'Brasil', '2023-02-20'),
(3, 'Carlos Tech', 'Curitiba', 'PR', 'Brasil', '2023-03-10'),
(4, 'Ana Gamer', 'Belo Horizonte', 'MG', 'Brasil', '2023-05-05');

-- Fidelidade inicial
INSERT INTO Fidelidade_Cliente (id_cliente, pontos_acumulados) VALUES
(1, 150), (2, 300), (3, 50), (4, 1200);

-- 2. INSERINDO PRODUTOS (Tabela Pai)
-- IDs manuais para facilitar as relações abaixo
INSERT INTO Produto (id_produto, nome_produto, categoria, preco_unitario, custo_unitario, estoque_atual, estoque_minimo) VALUES 
(1, 'Smartphone Galaxy S23', 'Telefonia', 4500.00, 3000.00, 50, 5),
(2, 'Dell XPS 13', 'Informática', 8500.00, 6000.00, 20, 2),
(3, 'NVIDIA RTX 4070', 'Hardware', 4200.00, 3100.00, 15, 3),
(4, 'Intel Core i9 13900K', 'Hardware', 3800.00, 2800.00, 30, 5),
(5, 'Logitech G Pro', 'Acessórios', 600.00, 350.00, 100, 10),
(6, 'Razer Deathadder', 'Acessórios', 350.00, 150.00, 80, 10);

-- Desconto Promocional aplicado
INSERT INTO Desconto_Aplicado (id_desconto, id_pedido, tipo, porcentagem, descricao)
VALUES (1, NULL, 'promocional', 5.00, 'Primeira Compra');

-- Desconto tipo 'parceria'
INSERT INTO Desconto_Aplicado (id_desconto, id_pedido, tipo, porcentagem, descricao)
VALUES (2, NULL, 'parceria', 10.00, 'Para clientes que compraram mais de 2 perifericos');

-- Desconto tipo 'parceria'
INSERT INTO Desconto_Aplicado (id_desconto, id_pedido, tipo, porcentagem, descricao)
VALUES (3, NULL, 'fidelidade', 10.00, 'Para clientes com mais de 100 pontos de fidelidade');


-- 3. ESPECIALIZANDO OS PRODUTOS (Tabelas Filhas)

-- Dispositivos
INSERT INTO Dispositivo (id_produto, cor, dimensao, tipo) VALUES 
(1, 'Preto', '146.3 x 70.9 mm', 'Smartphone'),
(2, 'Prata', '13 polegadas', 'Laptop');

-- Hardware
INSERT INTO Hardware (id_produto, consumo_energia, especificacao_tecnica, tipo) VALUES 
(3, 200, '12GB GDDR6X', 'GPU'),
(4, 125, '24 Cores, 32 Threads', 'CPU');

-- Periféricos
INSERT INTO Periferico (id_produto, cor, conexao, tipo) VALUES 
(5, 'Preto RGB', 'USB', 'Teclado'),
(6, 'Verde', 'Wireless', 'Mouse');

-- Ajustar sequência de produtos (caso use SERIAL)
SELECT setval('produto_id_produto_seq', (SELECT MAX(id_produto) FROM Produto));


-- 4. PEDIDOS E VENDAS (Usando seus ENUMS corretos)

-- CENÁRIO 1: Pedido Concluído (Pago com PIX)
-- Cliente 1 comprou Produto 1
INSERT INTO Pedido (id_pedido, data_pedido, prazo_estimado, status_pedido, prioridade_pedido, modo_envio, id_cliente, pontos_fidelidade_gerados)
VALUES (1, '2023-10-01', '2023-10-05', 'concluido', 'media', 'entrega', 1, 45);

INSERT INTO Item_Pedido (id_pedido, id_produto, quantidade, preco_unitario, desconto_unitario, valor_total_item)
VALUES (1, 1, 1, 4500.00, 0.00, 4500.00);

INSERT INTO Venda (id_pedido, custo_envio, custo_imposto_loja, custo_taxa_pagamento, valor_frete, valor_imposto_cliente, subtotal, valor_desconto, valor_total)
VALUES (1, 20.00, 150.00, 10.00, 35.00, 200.00, 4500.00, 0.00, 4735.00);

INSERT INTO Pagamento (id_pedido, forma_pagamento, parcelas, data_pagamento, valor_pago)
VALUES (1, 'pix', 1, '2023-10-01', 4735.00);


-- CENÁRIO 2: Pedido Grande Gamer (Enviando)
-- Cliente 4 comprou GPU(3), CPU(4), Teclado(5), Mouse(6)
INSERT INTO Pedido (id_pedido, data_pedido, prazo_estimado, status_pedido, prioridade_pedido, modo_envio, id_cliente, pontos_fidelidade_gerados)
VALUES (2, '2023-11-10', '2023-11-20', 'enviando', 'alta', 'entrega', 4, 100);

INSERT INTO Item_Pedido (id_pedido, id_produto, quantidade, preco_unitario, desconto_unitario, valor_total_item) VALUES
(2, 3, 1, 4200.00, 0.00, 4200.00),
(2, 4, 1, 3800.00, 0.00, 3800.00),
(2, 5, 1, 600.00, 50.00, 550.00),
(2, 6, 1, 350.00, 0.00, 350.00);

INSERT INTO Venda (id_pedido, custo_envio, custo_imposto_loja, custo_taxa_pagamento, valor_frete, valor_imposto_cliente, subtotal, valor_desconto, valor_total)
VALUES (2, 50.00, 400.00, 100.00, 80.00, 500.00, 8950.00, 50.00, 9480.00);

-- Pagamento com Cartão de Crédito
INSERT INTO Pagamento (id_pedido, forma_pagamento, parcelas, data_pagamento, valor_pago)
VALUES (2, 'cartao_credito', 10, '2023-11-10', 9480.00);


-- CENÁRIO 3: Pedido Pequeno (Retirada / Pendente)
-- Cliente 2 comprou Mouse(6)
INSERT INTO Pedido (id_pedido, data_pedido, prazo_estimado, status_pedido, prioridade_pedido, modo_envio, id_cliente, pontos_fidelidade_gerados)
VALUES (3, '2023-11-15', '2023-11-16', 'pendente', 'baixa', 'retirada', 2, 5);

INSERT INTO Item_Pedido (id_pedido, id_produto, quantidade, preco_unitario, desconto_unitario, valor_total_item)
VALUES (3, 6, 1, 350.00, 0.00, 350.00);

INSERT INTO Venda (id_pedido, custo_envio, custo_imposto_loja, custo_taxa_pagamento, valor_frete, valor_imposto_cliente, subtotal, valor_desconto, valor_total)
VALUES (3, 0.00, 10.00, 5.00, 0.00, 20.00, 350.00, 0.00, 370.00);

-- Pagamento com Cartão de Débito
INSERT INTO Pagamento (id_pedido, forma_pagamento, parcelas, data_pagamento, valor_pago)
VALUES (3, 'cartao_debito', 1, '2023-11-15', 370.00);


-- CENÁRIO 4: Pedido Corporativo (Iniciado / Sem Pagamento ainda)
-- Cliente 3 comprou 3 Notebooks(2)
-- Nota: Usei 'alta' prioridade pois 'critica' não existe no seu enum.
INSERT INTO Pedido (id_pedido, data_pedido, prazo_estimado, status_pedido, prioridade_pedido, modo_envio, id_cliente, pontos_fidelidade_gerados)
VALUES (4, '2023-12-01', '2023-12-15', 'iniciado', 'alta', 'entrega', 3, 200);

INSERT INTO Item_Pedido (id_pedido, id_produto, quantidade, preco_unitario, desconto_unitario, valor_total_item)
VALUES (4, 2, 3, 8500.00, 500.00, 24000.00);

INSERT INTO Venda (id_pedido, custo_envio, custo_imposto_loja, custo_taxa_pagamento, valor_frete, valor_imposto_cliente, subtotal, valor_desconto, valor_total)
VALUES (4, 100.00, 1000.00, 0.00, 150.00, 2000.00, 25500.00, 1500.00, 26150.00);

-- Ajustar sequência de pedidos
SELECT setval('pedido_id_pedido_seq', (SELECT MAX(id_pedido) FROM Pedido));

COMMIT;














