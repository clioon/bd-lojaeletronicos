<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rios Gerenciais - Kabom</title>
    
    <link rel="stylesheet" href="css/style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Estilos espec√≠ficos para o Dashboard de Relat√≥rios */
        body {
            background-color: #f4f6f8; /* Fundo levemente cinza */
        }

        .admin-header {
            background: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }

        .chart-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            /* Garante altura m√≠nima para o gr√°fico renderizar bem */
            min-height: 350px; 
            display: flex;
            flex-direction: column;
        }

        .chart-card h3 {
            color: #444;
            font-size: 1.1rem;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            padding-left: 10px;
        }

        /* Container relativo para o Chart.js controlar a responsividade */
        .canvas-container {
            flex: 1;
            position: relative;
            width: 100%;
            height: 300px;
        }

        /* Bot√µes */
        .btn-back {
            background: rgba(255,255,255,0.1);
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: background 0.2s;
        }
        .btn-back:hover { background: rgba(255,255,255,0.2); }

        .btn-print {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        /* Responsividade para celular */
        @media (max-width: 600px) {
            .dashboard-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header class="admin-header">
        <div style="display:flex; align-items:center; gap:15px;">
            <h2 style="margin:0;">Kabom Analytics</h2>
        </div>
        <div>
            <button onclick="window.print()" class="btn-print">üñ®Ô∏è Imprimir</button>
            <a href="home.html" class="btn-back">‚¨Ö Voltar para Loja</a>
        </div>
    </header>

    <div class="dashboard-container">

        <div class="chart-card">
            <h3>Faturamento por Categoria</h3>
            <div class="canvas-container"><canvas id="chart1"></canvas></div>
        </div>

        <div class="chart-card">
            <h3>Evolu√ß√£o de Pedidos (Mensal)</h3>
            <div class="canvas-container"><canvas id="chart2"></canvas></div>
        </div>

        <div class="chart-card">
            <h3>Top 10 Produtos Mais Vendidos</h3>
            <div class="canvas-container"><canvas id="chart3"></canvas></div>
        </div>

        <div class="chart-card">
            <h3>Top 10 Clientes (Faturamento)</h3>
            <div class="canvas-container"><canvas id="chart5"></canvas></div>
        </div>

        <div class="chart-card">
            <h3>Status dos Pedidos</h3>
            <div class="canvas-container"><canvas id="chart6"></canvas></div>
        </div>

        <div class="chart-card">
            <h3>M√©todos de Pagamento</h3>
            <div class="canvas-container"><canvas id="chart8"></canvas></div>
        </div>

        <div class="chart-card">
            <h3>üö® Alerta de Estoque Baixo</h3>
            <div class="canvas-container"><canvas id="chart9"></canvas></div>
        </div>

        <div class="chart-card">
            <h3>Vendas por Estado</h3>
            <div class="canvas-container"><canvas id="chart10"></canvas></div>
        </div>
        
        <div class="chart-card">
            <h3>Top Produtos por Lucro</h3>
            <div class="canvas-container"><canvas id="chart12"></canvas></div>
        </div>

    </div>

    <script>
        const API_URL = "http://localhost:5000";

        // Configura√ß√£o global de cores para manter consist√™ncia
        Chart.defaults.font.family = "'Segoe UI', 'Helvetica', 'Arial', sans-serif";
        Chart.defaults.color = '#666';
        
        const COLORS = [
            'rgba(54, 162, 235, 0.7)',  // Azul
            'rgba(255, 99, 132, 0.7)',  // Vermelho
            'rgba(255, 206, 86, 0.7)',  // Amarelo
            'rgba(75, 192, 192, 0.7)',  // Verde
            'rgba(153, 102, 255, 0.7)', // Roxo
            'rgba(255, 159, 64, 0.7)'   // Laranja
        ];

        // --- FUN√á√ÉO GEN√âRICA PARA CRIAR GR√ÅFICOS ---
        async function createChart(elementId, endpoint, config) {
            try {
                const response = await fetch(`${API_URL}/api/graficos/${endpoint}`);
                if (!response.ok) throw new Error("Erro na API");
                
                const data = await response.json();
                const ctx = document.getElementById(elementId).getContext('2d');

                // L√≥gica para montar os dados do Chart.js
                const chartData = {
                    labels: data[config.labelsKey], // Ex: data.categorias
                    datasets: config.customDataset ? config.customDataset(data) : [{
                        label: config.label || 'Valor',
                        data: data[config.dataKey],     // Ex: data.totais
                        backgroundColor: config.color || COLORS[0],
                        borderColor: config.borderColor || COLORS[0].replace('0.7', '1'),
                        borderWidth: 1
                    }]
                };

                new Chart(ctx, {
                    type: config.type || 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Importante para caber no card
                        indexAxis: config.horizontal ? 'y' : 'x',
                        plugins: {
                            legend: { display: !!config.showLegend }
                        }
                    }
                });

            } catch (error) {
                console.error(`Erro ao carregar gr√°fico ${elementId}:`, error);
                document.getElementById(elementId).parentElement.innerHTML = 
                    `<p style="color:red; text-align:center; padding-top:40px;">Erro ao carregar dados.</p>`;
            }
        }

        // --- INICIALIZA√á√ÉO DOS GR√ÅFICOS ---
        document.addEventListener("DOMContentLoaded", () => {
            
            // 1. Vendas por Categoria
            createChart('chart1', 'vendas-por-categoria', {
                labelsKey: 'categorias',
                dataKey: 'totais',
                label: 'Total Vendido (R$)',
                color: COLORS
            });

            // 2. Pedidos por M√™s (Linha)
            createChart('chart2', 'pedidos-por-mes', {
                type: 'line',
                labelsKey: 'meses',
                dataKey: 'total',
                label: 'Volume de Pedidos',
                borderColor: 'rgba(54, 162, 235, 1)',
                color: 'rgba(54, 162, 235, 0.1)' // Preenchimento suave
            });

            // 3. Top Produtos (Barra Horizontal)
            createChart('chart3', 'top-produtos', {
                horizontal: true,
                labelsKey: 'produtos',
                dataKey: 'quantidades',
                label: 'Unidades Vendidas',
                color: COLORS[3] // Verde
            });

            // 5. Top Clientes
            createChart('chart5', 'faturamento-por-cliente', {
                labelsKey: 'clientes',
                dataKey: 'totais',
                label: 'Gasto Total (R$)',
                color: COLORS[4] // Roxo
            });

            // 6. Status (Pizza)
            createChart('chart6', 'pedidos-por-status', {
                type: 'doughnut',
                labelsKey: 'status',
                dataKey: 'quantidades',
                showLegend: true,
                color: COLORS
            });

            // 8. Pagamentos (Pizza)
            createChart('chart8', 'vendas-por-forma-pagamento', {
                type: 'pie',
                labelsKey: 'formas',
                dataKey: 'quantidades',
                showLegend: true,
                color: COLORS
            });

            // 9. Estoque Cr√≠tico (Gr√°fico complexo com 2 barras)
            createChart('chart9', 'estoque-minimo-atual', {
                labelsKey: 'produtos',
                showLegend: true,
                customDataset: (data) => [
                    {
                        label: 'Estoque Atual',
                        data: data.atual,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)'
                    },
                    {
                        label: 'M√≠nimo Seguro',
                        data: data.minimo,
                        backgroundColor: 'rgba(255, 99, 132, 0.5)' // Vermelho alerta
                    }
                ]
            });

            // 10. Estados
            createChart('chart10', 'pedidos-por-estado', {
                horizontal: true,
                labelsKey: 'estados',
                dataKey: 'quantidades',
                label: 'Pedidos',
                color: COLORS[5]
            });

            // 12. Lucro
            createChart('chart12', 'lucro-por-produto', {
                labelsKey: 'produtos',
                dataKey: 'lucros',
                label: 'Lucro (R$)',
                color: COLORS[2] // Amarelo
            });

        });
    </script>
</body>
</html>