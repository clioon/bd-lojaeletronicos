-- Criação das tabelas

CREATE TABLE Cliente (
	id_cliente SERIAL PRIMARY KEY,
	nome_cliente VARCHAR(255) NOT NULL,
	cidade VARCHAR(100) NOT NULL,
	estado VARCHAR(100) NOT NULL,
	pais VARCHAR(100) NOT NULL,
	data_cadastro DATE DEFAULT CURRENT_DATE NOT NULL,
	-- TODO mercado
	-- TODO segmento
	
);

CREATE TABLE Produto (
	id_produto SERIAL PRIMARY KEY,
	nome_produto VARCHAR(255) NOT NULL,
	preco_unitario NUMERIC(10,2) NOT NULL,
	custo_unitario NUMERIC(10,2) NOT NULL,
	estoque_atual NUMERIC(10,2) NOT NULL,
	estoque_minimo NUMERIC(10,2) NOT NULL
	
);

CREATE TABLE Dispositivo (
	eid_produto INT PRIMARY KEY,
	cor VARCHAR(50) NOT NULL,
	dimensao VARCHAR(50) NOT NULL,
	tipo VARCHAR(100) NOT NULL,

	FOREIGN KEY (eid_produto) REFERENCES Produto(id_produto) ON DELETE CASCADE
);

CREATE TABLE Hardware (
	eid_produto INT PRIMARY KEY,
	consumo_energia INT NOT NULL,
	velocidade INT,
	tipo VARCHAR(100) NOT NULL,

	FOREIGN KEY (eid_produto) REFERENCES Produto(id_produto) ON DELETE CASCADE
);

CREATE TABLE Periferico(
	eid_produto INT PRIMARY KEY,
	cor VARCHAR(50) NOT NULL,
	conexao VARCHAR(50) NOT NULL,
	tipo VARCHAR(100) NOT NULL,

	FOREIGN KEY (eid_produto) REFERENCES Produto(id_produto) ON DELETE CASCADE
);

CREATE TYPE status_pedido_t AS ENUM ('iniciado', 'pendente', 'enviando', 'concluido', 'cancelado');

CREATE TABLE Pedido (
	id_pedido SERIAL PRIMARY KEY,
	data_pedido DATE,
	prazo_estimado DATE,
	status_pedido status_pedido_t DEFAULT 'iniciado' NOT NULL,
	prioridade_pedido INT DEFAULT 0 NOT NULL,
	modo_envio VARCHAR(100),
	rea_id_cliente INT NOT NULL,
	rea_pts_fidelidade INT DEFAULT 0,
	
	FOREIGN KEY (rea_id_cliente) REFERENCES Cliente(id_cliente) ON DELETE CASCADE
);

CREATE TABLE Venda (
	eid_pedido INT PRIMARY KEY,
	custo_envio NUMERIC(10,2),
	custo_imposto_loja NUMERIC(10,2) NOT NULL,
	custo_taxa_pagamento NUMERIC(10,2) NOT NULL,
	valor_frete NUMERIC(10,2),
	valor_imposto_cliente NUMERIC(10,2) NOT NULL,
	
	FOREIGN KEY (eid_pedido) REFERENCES Pedido(id_pedido) ON DELETE CASCADE
);

CREATE TABLE Pagamento (
	eeid_pedido INT PRIMARY KEY,
	forma_pagamento VARCHAR(100) NOT NULL,
	parcelas INT,

	FOREIGN KEY (eeid_pedido) REFERENCES Venda(eid_pedido) ON DELETE CASCADE
);

CREATE TABLE Desconto_Aplicado (
	eeid_pedido INT,
	tipo VARCHAR(100) NOT NULL,
	porcentagem INT NOT NULL,
	descricao VARCHAR(200),
	
	PRIMARY KEY (eeid_pedido, tipo),
	FOREIGN KEY (eeid_pedido) REFERENCES Venda(eid_pedido) ON DELETE CASCADE
);

-- pedido contem produto (N:M)
CREATE TABLE Contem (
	eid_pedido INT,
	eid_produto INT,
	desconto_unitario INT,

	PRIMARY KEY (eid_pedido, eid_produto),
	FOREIGN KEY (eid_pedido) REFERENCES Pedido(id_pedido) ON DELETE CASCADE,
	FOREIGN KEY (eid_produto) REFERENCES Produto(id_produto) ON DELETE CASCADE
);

-- ===================